@model IEnumerable<BestelApp_Models.Shoe>

@{
    ViewData["Title"] = "Schoenen";
}

<style>
    /* Filter UI is now global (site.css) via .filterbar-luxe + .dd-luxe */

    .product-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Mobiel: 2 kolommen */
        gap: 1rem;
        margin-top: 2rem;
    }

    /* Tablet: 3 kolommen */
    @@media (min-width: 768px) {
        .product-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
    }

    /* Desktop: 4 kolommen */
    @@media (min-width: 1200px) {
        .product-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }
    }

    .product-card {
        background: var(--gradient-card);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid hsl(var(--border));
        box-shadow: var(--shadow-soft);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    /* Hele kaart klikbaar (naar details) maar action buttons blijven klikbaar */
    .product-card-link {
        position: absolute;
        inset: 0;
        z-index: 1;
        text-decoration: none;
    }

    .product-actions {
        z-index: 3;
    }

    .product-info {
        position: relative;
        z-index: 2;
    }

    .product-image-container {
        position: relative;
        width: 100%;
        height: 200px; /* Mobiel: kleiner */
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    /* Tablet en desktop: groter */
    @@media (min-width: 768px) {
        .product-image-container {
            height: 250px;
        }
    }

    @@media (min-width: 1200px) {
        .product-image-container {
            height: 300px;
        }
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 2;
    }

    .product-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 2;
    }

    .action-btn {
        width: 36px; /* Mobiel: kleiner */
        height: 36px;
        border-radius: 50%;
        border: 1px solid hsl(var(--border));
        background: hsl(var(--card));
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: var(--shadow-soft);
        transition: all 0.3s ease;
        font-size: 1rem; /* Mobiel: kleiner */
    }

    @@media (min-width: 768px) {
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }
    }

    .action-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .favorite-btn {
        color: hsl(var(--primary));
    }

    .favorite-btn.active {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border-color: hsl(var(--primary));
    }

    .product-info {
        padding: 1rem; /* Mobiel: minder padding */
    }

    @@media (min-width: 768px) {
        .product-info {
            padding: 1.5rem;
        }
    }

    .product-category {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }

    .product-name {
        font-size: 0.95rem; /* Mobiel: kleiner */
        font-weight: 600;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
        min-height: 2.5rem; /* Mobiel: minder hoogte */
        line-height: 1.3;
    }

    @@media (min-width: 768px) {
        .product-name {
            font-size: 1.1rem;
            min-height: 3rem;
        }
    }

    @@media (min-width: 1200px) {
        .product-name {
            font-size: 1.25rem;
        }
    }

    .product-brand {
        font-size: 0.9rem;
        color: hsl(var(--muted-foreground));
        margin-bottom: 1rem;
    }

    .product-price {
        font-size: 1.25rem; /* Mobiel: kleiner */
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 0.75rem;
    }

    @@media (min-width: 768px) {
        .product-price {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
    }

    .add-to-cart-btn {
        width: 100%;
        padding: 10px; /* Mobiel: minder padding */
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border: 1px solid hsl(var(--primary));
        border-radius: 14px;
        font-weight: 600;
        font-size: 0.875rem; /* Mobiel: kleiner font */
        cursor: pointer;
        transition: background 0.3s ease;
    }

    @@media (min-width: 768px) {
        .add-to-cart-btn {
            padding: 12px;
            font-size: 1rem;
        }
    }

    .add-to-cart-btn:hover {
        background: hsl(var(--primary-dark));
        border-color: hsl(var(--primary-dark));
    }

</style>

@if (User.Identity?.IsAuthenticated == true)
{
    <script>
        // Laad favoriet status voor alle producten wanneer pagina geladen is
        document.addEventListener('DOMContentLoaded', function() {
            laadFavorietStatus();
        });

        async function laadFavorietStatus() {
            const favoriteButtons = document.querySelectorAll('.favorite-btn[data-shoe-id]');
            
            for (const btn of favoriteButtons) {
                const shoeId = btn.getAttribute('data-shoe-id');
                try {
                    const response = await fetch(`https://localhost:7001/api/favorites/check/${shoeId}`, {
                        credentials: 'include' // Include cookies voor authenticatie
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.isFavorite) {
                            btn.classList.add('active');
                            btn.setAttribute('data-is-favorite', 'true');
                            btn.title = 'Verwijderen uit favorieten';
                        }
                    }
                } catch (error) {
                    console.error('Fout bij checken favoriet status:', error);
                }
            }
        }

        async function toggleFavorite(shoeId, button) {
            const isFavorite = button.getAttribute('data-is-favorite') === 'true';
            const apiUrl = `https://localhost:7001/api/favorites/${shoeId}`;
            
            try {
                let response;
                if (isFavorite) {
                    // Verwijder uit favorieten
                    response = await fetch(apiUrl, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                } else {
                    // Voeg toe aan favorieten
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        credentials: 'include'
                    });
                }

                if (response.ok) {
                    // Toggle UI state
                    if (isFavorite) {
                        button.classList.remove('active');
                        button.setAttribute('data-is-favorite', 'false');
                        button.title = 'Toevoegen aan favorieten';
                    } else {
                        button.classList.add('active');
                        button.setAttribute('data-is-favorite', 'true');
                        button.title = 'Verwijderen uit favorieten';
                    }
                } else {
                    const errorData = await response.json();
                    alert('Fout: ' + (errorData.message || 'Er ging iets fout'));
                }
            } catch (error) {
                console.error('Fout bij toggle favoriet:', error);
                alert('Er ging iets fout bij het toevoegen/verwijderen van favoriet');
            }
        }
    </script>
}

<!-- Premium Header -->
<div class="container">
    <div class="catalog-hero">
        <div class="catalog-kicker">Schoenen Collectie</div>
        <h1 class="catalog-title">Ontdek Onze Schoenen</h1>
        <p class="catalog-subtitle">Een rustige, premium selectie met focus op kwaliteit en stijl.</p>
    </div>
</div>

<div class="container">
    <!-- Filters en Sorteren -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filters-shell" style="padding: 0; background: transparent; border: none; box-shadow: none;">
                <form method="get" action="@Url.Action("Index", "Shoes")" class="filterbar-luxe" id="shoesFilterForm">
                    <!-- Search -->
                    <div class="filterbar-span-2">
                        <div class="filterbar-label">Zoeken</div>
                        <div class="filterbar-search">
                            <input type="text"
                                   name="search"
                                   id="filterSearch"
                                   class="input-luxe w-100"
                                   placeholder="Zoek schoenen..."
                                   value="@ViewBag.Search" />
                            <button type="button" class="filterbar-clear" id="filterClearBtn" aria-label="Zoekveld leegmaken">
                                ×
                            </button>
                        </div>
                    </div>

                    <!-- Category (custom dropdown) -->
                    <div class="dd-luxe" data-dd="categoryId">
                        <div class="filterbar-label">Categorie</div>
                        <input type="hidden" name="categoryId" value="@(ViewBag.CategoryId ?? "")" />
                        <button class="dd-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                            <span class="dd-value">Alle</span>
                            <span class="dd-icon"><i data-lucide="chevron-down" style="width:16px;height:16px;"></i></span>
                        </button>
                        <div class="dd-menu" role="listbox">
                            <button type="button" class="dd-item" data-value="">Alle</button>
                            @if (ViewBag.Categorieen != null)
                            {
                                foreach (var c in ViewBag.Categorieen)
                                {
                                    <button type="button" class="dd-item" data-value="@c.Id">@c.Name</button>
                                }
                            }
                        </div>
                    </div>

                    <!-- Gender (custom dropdown) -->
                    <div class="dd-luxe" data-dd="gender">
                        <div class="filterbar-label">Geslacht</div>
                        <input type="hidden" name="gender" value="@(ViewBag.Gender ?? "Alles")" />
                        <button class="dd-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                            <span class="dd-value">Alle</span>
                            <span class="dd-icon"><i data-lucide="chevron-down" style="width:16px;height:16px;"></i></span>
                        </button>
                        <div class="dd-menu" role="listbox">
                            <button type="button" class="dd-item" data-value="Alles">Alle</button>
                            <button type="button" class="dd-item" data-value="Female">Vrouwen</button>
                            <button type="button" class="dd-item" data-value="Male">Mannen</button>
                            <button type="button" class="dd-item" data-value="Unisex">Uniseks</button>
                        </div>
                    </div>

                    <!-- Sort (custom dropdown) -->
                    <div class="dd-luxe" data-dd="sortBy">
                        <div class="filterbar-label">Sorteren</div>
                        <input type="hidden" name="sortBy" value="@(ViewBag.SortBy ?? "nieuwste")" />
                        <button class="dd-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                            <span class="dd-value">Nieuwste</span>
                            <span class="dd-icon"><i data-lucide="chevron-down" style="width:16px;height:16px;"></i></span>
                        </button>
                        <div class="dd-menu" role="listbox">
                            <button type="button" class="dd-item" data-value="nieuwste">Nieuwste</button>
                            <button type="button" class="dd-item" data-value="oudste">Oudste</button>
                            <button type="button" class="dd-item" data-value="prijs-laag">Prijs ↑</button>
                            <button type="button" class="dd-item" data-value="prijs-hoog">Prijs ↓</button>
                            <button type="button" class="dd-item" data-value="naam-az">Naam A‑Z</button>
                            <button type="button" class="dd-item" data-value="naam-za">Naam Z‑A</button>
                        </div>
                    </div>

                    <!-- Apply + Reset -->
                    <div class="filterbar-apply-full" style="display:flex; gap:12px; align-items:end;">
                        <button type="submit" class="btn-luxe w-100" style="height:46px; border-radius: var(--radius-lg);">Toepassen</button>
                        <button type="button" class="btn-luxe-ghost" id="filterResetBtn" style="height:46px; border-radius: var(--radius-lg);">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    @if (User.IsInRole("Admin"))
    {
        <div class="mb-4">
            <a asp-action="Create" class="btn btn-success btn-lg">
                ➕ Nieuwe Schoen Toevoegen
            </a>
        </div>
    }

    @if (TempData["SuccessBericht"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>✓</strong> @TempData["SuccessBericht"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="product-grid">
            @foreach (var product in Model)
            {
                <div class="product-card">
                    <a class="product-card-link" asp-action="Details" asp-route-id="@product.Id" aria-label="Bekijk details"></a>
                    <!-- Product Image -->
                    <div class="product-image-container">
                        @if (!string.IsNullOrEmpty(product.ImageUrl))
                        {
                            <img src="@product.ImageUrl"
                                 alt="@product.Name"
                                 class="product-image"
                                 onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22600%22%3E%3Crect fill=%22%23f8f9fa%22 width=%22800%22 height=%22600%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2260%22%3E%F0%9F%91%9F%3C/text%3E%3C/svg%3E';" />
                        }
                        else
                        {
                            <div style="font-size: 5rem; color: #dee2e6;">👟</div>
                        }
                        
                        <!-- Badge -->
                        @if (product.CreatedAt > DateTime.UtcNow.AddDays(-30))
                        {
                            <div class="product-badge">Nieuw</div>
                        }

                        <!-- Action Buttons -->
                        <div class="product-actions">
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                <button type="button" 
                                        class="action-btn favorite-btn" 
                                        data-shoe-id="@product.Id"
                                        data-is-favorite="false"
                                        onclick="toggleFavorite(@product.Id, this)"
                                        title="Toevoegen aan favorieten">
                                    <i data-lucide="heart" style="width:18px;height:18px;"></i>
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="product-info">
                        <div class="product-category">@(product.Category?.Name ?? "Schoenen")</div>
                        <h3 class="product-name">@product.Name</h3>
                        <p class="product-brand">@product.Brand</p>
                        <div class="product-price">€@product.Price.ToString("0.00")</div>
                        
                        <!-- Stok Info -->
                        @{
                            var totalStock = product.Variants?.Sum(v => v.Stock) ?? 0;
                            var availableVariants = product.Variants?.Count(v => v.Stock > 0) ?? 0;
                        }
                        <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">
                            @(totalStock > 0 ? $"Op voorraad ({totalStock})" : "Uitverkocht")
                        </div>
                        
                        <a asp-action="Details" asp-route-id="@product.Id" class="add-to-cart-btn" style="text-decoration: none; display: block; text-align: center; position: relative; z-index: 4;">
                            Bekijk details
                        </a>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-5">
            <h4>📦 Geen schoenen beschikbaar</h4>
            <p>Er zijn nog geen producten toegevoegd.</p>
            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Create" class="btn btn-primary mt-3">Voeg eerste schoen toe</a>
            }
        </div>
    }
</div>
