@model BestelApp_Models.Shoe

@{
    ViewData["Title"] = Model.Name;
}

<style>
    .product-detail-container {
        margin-top: 2rem;
    }

    .product-image-section {
        position: relative;
    }

    .product-main-image {
        width: 100%;
        height: 500px;
        object-fit: cover;
        border-radius: 16px;
        background: hsl(var(--muted));
        border: 1px solid hsl(var(--border));
        box-shadow: var(--shadow-soft);
    }

    .product-info-section {
        padding-left: 2rem;
    }

    .product-category {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }

    .product-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: hsl(var(--foreground));
        font-family: "Playfair Display", serif;
        margin-bottom: 1rem;
    }

    .product-brand {
        font-size: 1.25rem;
        color: hsl(var(--muted-foreground));
        margin-bottom: 1.5rem;
    }

    .product-price {
        font-size: 2rem;
        font-weight: 700;
        color: hsl(var(--primary));
        margin-bottom: 2rem;
    }

    .product-description {
        font-size: 1rem;
        color: hsl(var(--muted-foreground));
        line-height: 1.8;
        margin-bottom: 2rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .favorite-btn-large {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 1px solid hsl(var(--border));
        background: hsl(var(--card));
        color: hsl(var(--primary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-soft);
    }

    .favorite-btn-large:hover {
        border-color: hsl(var(--primary));
        color: hsl(var(--primary));
        transform: translateY(-1px);
    }

    .favorite-btn-large.active {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border-color: hsl(var(--primary));
    }

    .variant-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid hsl(var(--border));
    }

    .variant-title {
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .variant-picker {
        margin-top: 1.25rem;
    }

    .variant-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .variant-headline {
        font-size: 0.85rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: hsl(var(--muted-foreground));
        font-weight: 700;
    }

    .variant-help {
        font-size: 0.95rem;
        color: hsl(var(--muted-foreground));
    }

    .chip-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .chip {
        border: 1px solid hsl(var(--border));
        background: hsl(var(--card));
        color: hsl(var(--foreground));
        border-radius: var(--radius-pill);
        padding: 10px 14px;
        min-height: 42px;
        font-weight: 700;
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .chip:hover {
        border-color: hsl(var(--primary));
        color: hsl(var(--primary));
        transform: translateY(-1px);
    }

    .chip.is-selected {
        background: hsl(var(--primary));
        border-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }

    .chip.is-disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
    }

    .chip.is-disabled:hover {
        border-color: hsl(var(--border));
        color: hsl(var(--foreground));
        background: hsl(var(--card));
    }

    .variant-selected-info {
        margin-top: 0.75rem;
        font-size: 0.95rem;
        color: hsl(var(--muted-foreground));
    }

    .quantity-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }

    .quantity-row input[type="number"] {
        width: 90px;
        border-radius: var(--radius-md);
        border: 1px solid hsl(var(--border));
        background: hsl(var(--card));
        padding: 0.6rem 0.75rem;
    }
</style>

<div class="container product-detail-container">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6 product-image-section">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="@Model.Name" class="product-main-image" />
            }
            else
            {
                <div class="product-main-image d-flex align-items-center justify-content-center" style="font-size: 8rem; color: #dee2e6;">
                    👟
                </div>
            }
        </div>

        <!-- Product Info -->
        <div class="col-md-6 product-info-section">
            <div class="product-category">@(Model.Category?.Name ?? "Schoenen")</div>
            <h1 class="product-title">@Model.Name</h1>
            <p class="product-brand">@Model.Brand</p>
            <div class="product-price">€@Model.Price.ToString("0.00")</div>
            
            <!-- Stok Info -->
            @{
                var totalStock = Model.Variants?.Sum(v => v.Stock) ?? 0;
                var availableVariants = Model.Variants?.Count(v => v.Stock > 0) ?? 0;
            }
            @if (totalStock > 0)
            {
                <div style="font-size: 1rem; color: hsl(var(--muted-foreground)); margin-bottom: 1rem; font-weight: 600;">
                    Op voorraad (@totalStock stuks beschikbaar)
                </div>
            }
            else
            {
                <div style="font-size: 1rem; color: hsl(var(--muted-foreground)); margin-bottom: 1rem; font-weight: 600;">
                    Uitverkocht
                </div>
            }
            
            <p class="product-description">@Model.Description</p>

            <!-- Variants Section (maat/kleur kiezen) -->
            @if (Model.Variants != null && Model.Variants.Any())
            {
                <div class="variant-section">
                    <h4 class="variant-title">Selecteer maat & kleur</h4>

                    <div class="variant-picker">
                        <div class="variant-head">
                            <div class="variant-headline">Kleur</div>
                            <div class="variant-help" id="kleurHelp">Selecteer een kleur</div>
                        </div>
                        <div class="chip-grid" id="kleurChips"></div>
                    </div>

                    <div class="variant-picker">
                        <div class="variant-head">
                            <div class="variant-headline">Maat</div>
                            <div class="variant-help" id="maatHelp">Selecteer een maat</div>
                        </div>
                        <div class="chip-grid" id="maatChips"></div>
                    </div>

                    <div class="variant-selected-info" id="selectedVariantInfo">
                        Selecteer een maat en kleur om toe te voegen aan de winkelwagen.
                    </div>

                    <div class="quantity-row">
                        <label style="font-weight:600; color:hsl(var(--foreground)); margin:0;">Aantal:</label>
                        <input id="quantityInput" type="number" min="1" value="1" disabled />
                        <span id="stockHint" style="font-size:0.9rem; color:hsl(var(--muted-foreground));"></span>
                    </div>

                    <input type="hidden" id="selectedVariantId" value="" />
                </div>
            }

            <!-- Action Buttons -->
            <div class="action-buttons">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <button type="button" 
                            class="favorite-btn-large" 
                            data-shoe-id="@Model.Id"
                            data-is-favorite="false"
                            onclick="toggleFavorite(@Model.Id, this)"
                            title="Toevoegen aan favorieten">
                        <i data-lucide="heart" style="width:20px;height:20px;"></i>
                    </button>

                    <form asp-controller="Cart" asp-action="Add" method="post" style="flex:1;">
                        <input type="hidden" id="cartVariantId" name="shoeVariantId" value="" />
                        <input type="hidden" id="cartQuantity" name="quantity" value="1" />
                        <input type="hidden" name="returnUrl" value="@Url.Action("Details", "Shoes", new { id = Model.Id })" />
                        <button type="submit"
                                id="addToCartBtn"
                                class="btn-luxe w-100"
                                disabled>
                            In Winkelwagen
                        </button>
                    </form>
                }
                else
                {
                    <a class="btn-luxe w-100" asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Url.Action("Details", "Shoes", new { id = Model.Id })">
                        Inloggen om te bestellen
                    </a>
                }
            </div>

            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="d-flex justify-content-end" style="margin-top: 0.75rem;">
                    <a class="btn-luxe-outline" asp-controller="Cart" asp-action="Index">Naar winkelwagen</a>
                </div>
            }
            
            @if (User.Identity?.IsAuthenticated == true)
            {
                <script>
                    // Laad favoriet status voor dit product
                    document.addEventListener('DOMContentLoaded', function() {
                        const button = document.querySelector('.favorite-btn-large[data-shoe-id="@Model.Id"]');
                        if (button) {
                            checkFavoriteStatus(@Model.Id, button);
                        }
                    });

                    async function checkFavoriteStatus(shoeId, button) {
                        try {
                            const response = await fetch(`${window.API_BASE_URL}/api/favorites/check/${shoeId}`, {
                                credentials: 'include'
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.isFavorite) {
                                    button.classList.add('active');
                                    button.setAttribute('data-is-favorite', 'true');
                                    button.title = 'Verwijderen uit favorieten';
                                }
                            }
                        } catch (error) {
                            console.error('Fout bij checken favoriet status:', error);
                        }
                    }

                    async function toggleFavorite(shoeId, button) {
                        const isFavorite = button.getAttribute('data-is-favorite') === 'true';
                        const apiUrl = `${window.API_BASE_URL}/api/favorites/${shoeId}`;
                        
                        try {
                            let response;
                            if (isFavorite) {
                                response = await fetch(apiUrl, {
                                    method: 'DELETE',
                                    credentials: 'include'
                                });
                            } else {
                                response = await fetch(apiUrl, {
                                    method: 'POST',
                                    credentials: 'include'
                                });
                            }

                            if (response.ok) {
                                if (isFavorite) {
                                    button.classList.remove('active');
                                    button.setAttribute('data-is-favorite', 'false');
                                    button.title = 'Toevoegen aan favorieten';
                                } else {
                                    button.classList.add('active');
                                    button.setAttribute('data-is-favorite', 'true');
                                    button.title = 'Verwijderen uit favorieten';
                                }
                            } else {
                                const errorData = await response.json();
                                alert('Fout: ' + (errorData.message || 'Er ging iets fout'));
                            }
                        } catch (error) {
                            console.error('Fout bij toggle favoriet:', error);
                            alert('Er ging iets fout bij het toevoegen/verwijderen van favoriet');
                        }
                    }
                </script>
            }

            <script>
                // Variant UX (chips) - werkt ook zonder login; CTA blijft login-gated
                let geselecteerdeVariantId = null;
                let geselecteerdeVariantStock = 0;
                let geselecteerdeMaat = null;
                let geselecteerdeKleur = null;

                const varianten = [
@foreach (var variant in (Model.Variants ?? Enumerable.Empty<BestelApp_Models.ShoeVariant>()))
{
<text>                    { id: @variant.Id, maat: @variant.Size, kleur: "@(((variant.Color ?? string.Empty).Replace("\"","\\\"")))", stock: @variant.Stock },</text>
}
                ];

                function uniekeMaten() {
                    return [...new Set(varianten.map(v => v.maat))].sort((a, b) => a - b);
                }

                function uniekeKleuren() {
                    return [...new Set(varianten.map(v => v.kleur))].sort();
                }

                function variantVoor(maat, kleur) {
                    return varianten.find(v => v.maat === maat && v.kleur === kleur) || null;
                }

                function heeftStock(maat, kleur) {
                    const v = variantVoor(maat, kleur);
                    return !!v && v.stock > 0;
                }

                function renderKleurChips() {
                    const wrap = document.getElementById('kleurChips');
                    if (!wrap) return;
                    wrap.innerHTML = '';

                    uniekeKleuren().forEach(kleur => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'chip';
                        btn.textContent = kleur;
                        btn.setAttribute('data-kleur', kleur);
                        btn.addEventListener('click', function() {
                            // Toggle: als zelfde kleur, deselecteer; anders selecteer nieuwe
                            if (geselecteerdeKleur === kleur) {
                                geselecteerdeKleur = null;
                                geselecteerdeMaat = null; // Reset maat ook
                            } else {
                                geselecteerdeKleur = kleur;
                                geselecteerdeMaat = null; // Reset maat bij kleur wijziging
                            }
                            renderAll();
                        });
                        wrap.appendChild(btn);
                    });
                }

                function renderMaatChips() {
                    const wrap = document.getElementById('maatChips');
                    if (!wrap) return;
                    wrap.innerHTML = '';

                    uniekeMaten().forEach(maat => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'chip';
                        btn.textContent = maat.toString();
                        btn.setAttribute('data-maat', maat.toString());
                        btn.addEventListener('click', function() {
                            // Alleen selecteren als er (met gekozen kleur) stock is; anders negeren
                            if (geselecteerdeKleur && !heeftStock(maat, geselecteerdeKleur)) return;
                            
                            // Toggle: als zelfde maat, deselecteer; anders selecteer nieuwe
                            if (geselecteerdeMaat === maat) {
                                geselecteerdeMaat = null;
                            } else {
                                geselecteerdeMaat = maat;
                            }
                            renderAll();
                        });
                        wrap.appendChild(btn);
                    });
                }

                function updateChipStates() {
                    // Color chip states
                    document.querySelectorAll('#kleurChips .chip').forEach(el => {
                        const kleur = el.getAttribute('data-kleur');
                        const isSel = !!kleur && kleur === geselecteerdeKleur;
                        el.classList.toggle('is-selected', isSel);

                        // If size selected, mark colors without stock as disabled (still visible)
                        if (geselecteerdeMaat && kleur) {
                            const disabled = !heeftStock(geselecteerdeMaat, kleur);
                            el.classList.toggle('is-disabled', disabled);
                            el.toggleAttribute('disabled', disabled);
                        } else {
                            el.classList.remove('is-disabled');
                            el.removeAttribute('disabled');
                        }
                    });

                    // Size chip states
                    document.querySelectorAll('#maatChips .chip').forEach(el => {
                        const maat = parseInt(el.getAttribute('data-maat') || '0');
                        const isSel = !isNaN(maat) && geselecteerdeMaat === maat;
                        el.classList.toggle('is-selected', isSel);

                        if (geselecteerdeKleur) {
                            const disabled = !heeftStock(maat, geselecteerdeKleur);
                            el.classList.toggle('is-disabled', disabled);
                            el.toggleAttribute('disabled', disabled);
                        } else {
                            el.classList.remove('is-disabled');
                            el.removeAttribute('disabled');
                        }
                    });
                }

                function updateSelectionAndCta() {
                    const info = document.getElementById('selectedVariantInfo');
                    const qtyEl = document.getElementById('quantityInput');
                    const hint = document.getElementById('stockHint');
                    const hidden = document.getElementById('selectedVariantId');

                    const cartVariant = document.getElementById('cartVariantId');
                    const cartQty = document.getElementById('cartQuantity');
                    const btn = document.getElementById('addToCartBtn');

                    // Reset base
                    geselecteerdeVariantId = null;
                    geselecteerdeVariantStock = 0;
                    if (hidden) hidden.value = '';
                    if (cartVariant) cartVariant.value = '';
                    if (btn) btn.disabled = true;
                    if (qtyEl) qtyEl.disabled = true;
                    if (hint) hint.textContent = '';

                    // Guidance
                    if (!geselecteerdeKleur) {
                        if (info) info.textContent = 'Selecteer eerst een kleur.';
                        return;
                    }
                    if (!geselecteerdeMaat) {
                        if (info) info.textContent = 'Selecteer daarna een maat.';
                        return;
                    }

                    const variant = variantVoor(geselecteerdeMaat, geselecteerdeKleur);
                    if (!variant) {
                        if (info) info.textContent = 'Variant niet gevonden.';
                        return;
                    }
                    if (variant.stock <= 0) {
                        if (info) info.textContent = `Geselecteerd: ${geselecteerdeKleur} / ${geselecteerdeMaat} (uitverkocht)`;
                        return;
                    }

                    geselecteerdeVariantId = variant.id;
                    geselecteerdeVariantStock = variant.stock;
                    if (hidden) hidden.value = variant.id.toString();
                    if (cartVariant) cartVariant.value = variant.id.toString();

                    if (info) info.textContent = `Geselecteerd: ${geselecteerdeKleur} / ${geselecteerdeMaat}`;
                    if (qtyEl) {
                        qtyEl.disabled = false;
                        qtyEl.max = variant.stock.toString();
                        if (parseInt(qtyEl.value || '1') > variant.stock) qtyEl.value = variant.stock.toString();
                    }
                    if (cartQty && qtyEl) cartQty.value = qtyEl.value || '1';
                    if (hint) hint.textContent = `(max ${variant.stock})`;
                    if (btn) btn.disabled = false;
                }

                function renderAll() {
                    // If selected combination invalid after change, clear size selection
                    if (geselecteerdeKleur && geselecteerdeMaat && !heeftStock(geselecteerdeMaat, geselecteerdeKleur)) {
                        geselecteerdeMaat = null;
                    }

                    updateChipStates();
                    updateSelectionAndCta();
                }

                document.addEventListener('DOMContentLoaded', function() {
                    // Render chips once
                    renderKleurChips();
                    renderMaatChips();

                    // Quantity sync (if cart exists)
                    const qtyEl = document.getElementById('quantityInput');
                    const cartQty = document.getElementById('cartQuantity');
                    if (qtyEl && cartQty) {
                        qtyEl.addEventListener('input', function() {
                            let qty = parseInt(qtyEl.value || '1');
                            if (isNaN(qty) || qty < 1) qty = 1;
                            if (geselecteerdeVariantStock > 0 && qty > geselecteerdeVariantStock) qty = geselecteerdeVariantStock;
                            qtyEl.value = qty.toString();
                            cartQty.value = qty.toString();
                        });
                    }

                    // Prevent submit without variant (if form exists)
                    const btn = document.getElementById('addToCartBtn');
                    const cartVariant = document.getElementById('cartVariantId');
                    if (btn && cartVariant) {
                        btn.closest('form')?.addEventListener('submit', function(e) {
                            if (!geselecteerdeVariantId || !cartVariant.value) {
                                e.preventDefault();
                                alert('Selecteer eerst een maat en kleur');
                            }
                        });
                    }

                    renderAll();
                });
            </script>

            <!-- Variants Section -->

            <!-- Admin Actions -->
            @if (User.IsInRole("Admin"))
            {
                <div class="mt-4 pt-4 border-top">
                    <h5>Admin Acties</h5>
                    <div class="d-flex gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn-luxe-outline">Bewerk</a>
                        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn-luxe-danger">Verwijder</a>
                        <a asp-action="Index" class="btn-luxe-ghost">Terug</a>
                    </div>
                </div>
            }
            else
            {
                <div class="mt-4">
                    <a asp-action="Index" class="btn-luxe-outline">Terug naar schoenen</a>
                </div>
            }
        </div>
</div>
</div>
